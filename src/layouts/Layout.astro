---
import "../styles/global.css";
import Footer from "@components/Footer.astro";
import Nav from "@components/Nav.astro";

export interface Props {
  title: string;
}

const { title } = Astro.props as Props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/x-icon" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <meta name="view-transition" content="same-origin" />
    <title>{title}</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <script>
      import "../scripts/spa-navigation.js";
    </script>
  </head>
  <body class="font-sans bg-slate-700 text-white">
    <div id="root" class="h-screen overflow-hidden flex flex-col">
      <Nav />
      <div id="container" class="h-full flex-1 overflow-y-auto">
        <div id="content">
          <slot />
        </div>
        <Footer />
      </div>
    </div>
  </body>
</html>

<script>
  document.addEventListener("alpine:init", () => {
    Alpine.store("globalState", {
      movies: [],
      async init() {
        if (localStorage.getItem("user")) {
          const user = JSON.parse(localStorage.getItem("user"));
          // TODO: use id_token from localstorage as Bearer authorization header
          const response = await fetch(
            "/api/user/movies?user_email=" + user.email,
            {
              method: "GET",
              headers: { "Content-Type": "application/json" },
            }
          );

          if (response.ok) {
            const userMovies = await response.json();
            this.movies.push(...userMovies);
            this.syncToLocalStorage();
          }
        } else {
          this.movies.push(
            ...JSON.parse(localStorage.getItem("movies") || "[]")
          ); // Estado inicial
        }
      },
      // Guarda el estado actual en localStorage
      syncToLocalStorage() {
        localStorage.setItem("movies", JSON.stringify(this.movies));
      },
      // Limpia el estado global
      clearMovies() {
        this.movies = [];
        this.syncToLocalStorage();
      },
      getMovie(movieId) {
        return this.movies.find((m) => m.movie_id === movieId);
      },
      async updateMovieStatus(movieId, newStatus) {
        // Actualiza la pelicula en el estado de alpine
        if (this.movies.find((m) => m.movie_id === movieId)) {
          this.movies = this.movies.map((movie) =>
            movie.movie_id === movieId ? { ...movie, status: newStatus } : movie
          );
        } else {
          this.movies = [
            ...this.movies,
            { movie_id: movieId, status: newStatus },
          ];
        }
        // Guarda en localstorage
        this.syncToLocalStorage();
        // save user state (server)
        if (localStorage.getItem("user")) {
          const user = JSON.parse(localStorage.getItem("user"));
          const response = await fetch("/api/user/movies/" + movieId, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              userEmail: user.email,
              movieId,
              status: newStatus,
            }),
          });

          if (response.ok) {
            console.log("Estado actualizado correctamente");
            // Actualiza la UI segÃºn sea necesario
          }
        }
      },
    });
  });

  /*window.addEventListener("storage", (event) => {
    if (event.key === "movies") {
      const updatedData = JSON.parse(event.newValue || "[]");
      updateGlobalState(updatedData);
    }
  });*/
</script>
